<html>
  <head>
    <script src="/js/jquery.js"></script>
    <!--
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.1.1.min.js"></script>
    -->
    <link rel="stylesheet" href="/css/style.css">
  </head>
<body>

<script type="text/javascript">
var times = {};

function formatXml(xml) {
    var formatted = '';
    var reg = /(>)(<)(\/*)/g;
    xml = xml.replace(reg, '$1\r\n$2$3');
    var pad = 0;
    jQuery.each(xml.split('\r\n'), function(index, node) {
        var indent = 0;
        if (node.match( /.+<\/\w[^>]*>$/ )) {
            indent = 0;
        } else if (node.match( /^<\/\w/ )) {
            if (pad != 0) {
                pad -= 1;
            }
        } else if (node.match( /^<\w[^>]*[^\/]>.*$/ )) {
            indent = 1;
        } else {
            indent = 0;
        }
 
        var padding = '';
        for (var i = 0; i < pad; i++) {
            padding += '  ';
        }
 
        formatted += padding + node + '\r\n';
        pad += indent;
    });
 
    return formatted;
}
 
$.extend({
  getUrlVars: function(){
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
      hash = hashes[i].split('=');
      vars.push(hash[0]);
      vars[hash[0]] = hash[1];
    }
    return vars;
  },
  getUrlVar: function(name){
    return $.getUrlVars()[name];
  }
});

function getURLParameter(name) {
   return decodeURI((RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]);
}

function get_iq_id(data) {
    var xmlDoc = $.parseXML(data);
    $xml = $(xmlDoc);
    $title = $xml.find("iq");
    var id=$title.attr("id");
    return id;
}

    function xml_to_string(xml_node)
    {
        if (xml_node.xml)
            return xml_node.xml;
        else if (XMLSerializer)
        {
            var xml_serializer = new XMLSerializer();
            return xml_serializer.serializeToString(xml_node);
        }
        else
        {
            alert("ERROR: Extremely old browser");
            return "";
        }
    }

  $(document).ready(
    function() {
      var parts = window.location.href.split("/");
      var token = parts[parts.length-1];
      $('#foo').html(token);
      if (!!window.EventSource) {
         var source = new EventSource('/stream/'+token);
         source.onopen = function () {
           console.log("SSE opened");
         };
         source.onerror = function () {
           console.log("SSE error!");
         };
         source.onmessage = function (event) {
            var text = event.data;
            var json = JSON.parse(event.data);
            if (json.server == 'receive') {
              //var id = get_iq_id(json.data);
              //times[id] = new Date(json.timestamp);
              $('#received').html(parseInt($('#received').html())+1);
              $('#timeline').append(block(json.server, json.timestamp, json.data));
            }
            if (json.server == 'send') {
              //var id = get_iq_id(json.data);
              //var time = times[id];
              $('#sent').html(parseInt($('#sent').html())+1);
              $('#timeline').append(block(json.server, json.timestamp, json.data));
              //var diffDays = new Date(json.timestamp) - time;
              //$('#timestamp-'+id).append("Time to answer IQ - "+diffDays+" ms");
            }
            //$('#foo').html(token);
         };
      } else {
        console.log("event source unavailable");
        // Result to xhr polling :(
      }
    }
  );

  function block(direction, timestamp, data) {
      var xml_formatted = formatXml(data);
      var xml_escaped = xml_formatted.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/ /g, '&nbsp;').replace(/\n/g,'<br />');
      return '<div class="'+direction+' xmpp"><div class="timestamp">'+timestamp+'</div><div class="xml">'+xml_escaped+'</div></div>';
  }
</script>

<p align="center">
  <span class="count">Communication Inspector</span>
  <br/>
  <span>
      <script language="javascript">
           <!--
            var today = new Date();
            document.write(today);
           //-->
      </script>
  </span>
</p>

<p align="center">
  <span id="received"  class="count">0</span><span class="count" style="padding-left: 5px;">Client Sent</span>
  <br/>
  <span id="sent" class="count">0</span><span class="count" style="padding-left: 5px;">Server Sent</span>
</p>

<div id="timeline">
</div>

</body>
</html>
